<?php
/**
 * Created by PhpStorm.
 * User: dale.guo
 * Date: 11/25/16
 * Time: 4:10 PM
 */
use Drupal\user\Entity\User;
use Drupal\profile\Entity\Profile;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;

// [
// 	'field_fytv_video_id'=>45053,
// 	'status'=>1,
// 	'created'=>'190099202',
// 	'field_tags.entity.name'=>'cats',
// 	'field_lymeta_tid.entity.tid'=>$tid
// ]
function wxapi_get_nid($fields,$bundle='grace'){
    $bundle = 'grace';
    // $created = strtotime($date . ' 08:00:00 AM');
    $query = \Drupal::entityQuery('node');
    $query->condition('type', $bundle);
    foreach($fields as $key => $value) {
    	$query->condition($key, $value);
    }
    $query->range(0, 1);
//  https://www.sitepoint.com/drupal-8-version-entityfieldquery/
//	https://lakshminp.com/using-entity-api-drupal-8
//  ->condition('field_tags.entity.name', 'cats');
    $entity_ids = $query->execute();
    if (count($entity_ids)) {
        return $entity_ids[array_keys($entity_ids)[0]];
    } else {
        return NULL;
    }
}

//cron set new user pic url field then delete!!!
function wxapi_cron() {
    // https://api.drupal.org/api/drupal/core!includes!database.inc/function/db_select/8.2.x
    $query = \Drupal::database()->select('user__field_user_picture_url', 't');
    $query->addField('t', 'entity_id');
    $query->condition('t.bundle', 'user');
    $subquery_result = array_keys($query->execute()->fetchAllAssoc('entity_id'));
    if(empty($subquery_result)) $subquery_result=[0];

    $query = \Drupal::database()->select('users', 't');
    $query->addField('t', 'uid');
    // $query->condition('t.bundle', 'wechat_account_data');
    $query->condition('t.uid', $subquery_result, 'NOT IN');
    $query->range(0, 500);
    $uids = array_keys($query->execute()->fetchAllAssoc('uid'));
    foreach ($uids as $uid) {
        $user = User::load($uid);
        $profile_type = 'wechat_account_data';
        /* @var $profile Profile */
        $profile = \Drupal::entityTypeManager()->getStorage('profile')
            ->loadByUser($user, $profile_type);
        if ($profile && $profile->get('field_mp_accounts_hd_head_img')->value!=$user->get('field_user_picture_url')->value) {
            // \Drupal::logger('wxapi_cron')->notice($uid);
            $user->set('field_user_picture_url', $profile->get('field_mp_accounts_hd_head_img')->value);
            $user->save();
            \Drupal::logger('wxapi_account_cron')->notice($uid);
        }else{
          $profile_type = 'wechat_user_data';
          /* @var $profile Profile */
          $profile = \Drupal::entityTypeManager()->getStorage('profile')
              ->loadByUser($user, $profile_type);
          if ($profile && $profile->get('field_wxuser_headimgurl')->value!=$user->get('field_user_picture_url')->value) {
              \Drupal::logger('wxapi_cron')->notice($uid);
              $user->set('field_user_picture_url', $profile->get('field_wxuser_headimgurl')->value);
              $user->save();
          }
        }
    }

    // $query = \Drupal::database()->select('user__field_user_openids', 't');
    // $query->addField('t', 'entity_id');
    // $query->condition('t.bundle', 'user');
    // $query->condition('t.entity_id', $subquery_result, 'NOT IN');
    // $query->range(0, 100);
    // $uids = array_keys($query->execute()->fetchAllAssoc('entity_id'));
    // foreach ($uids as $uid) {
    //     $user = User::load($uid);
    //     $profile_type = 'wechat_user_data';
    //     /* @var $profile Profile */
    //     $profile = \Drupal::entityTypeManager()->getStorage('profile')
    //         ->loadByUser($user, $profile_type);
    //     if ($profile && $profile->get('field_wxuser_headimgurl')->value!=$user->get('field_user_picture_url')->value) {
    //         // \Drupal::logger('wxapi_cron')->notice($uid);
    //         $user->set('field_user_picture_url', $profile->get('field_wxuser_headimgurl')->value);
    //         $user->save();
    //     }
    // }
    // return $uids; 
}

function wxapi_entity_presave(Drupal\Core\Entity\EntityInterface $node){
    if(!$node->id()){ //for insert or udpate!
        $uri = FALSE;
        if($node->bundle()=='album' && $node->hasField('field_from_url') && !$node->get('field_from_url')->isEmpty()){
            $field_from_url = $node->get('field_from_url')->getValue();
            $uri = $field_from_url[0]['uri'];
        }
        if (strpos($uri, 'youtube.com/') !== FALSE ) {
          $type = $node->get('field_bundle_type')->value;
          $field_bundle_author = $node->get('field_bundle_author')->getValue();
          $uid = 1;
          if(isset($field_bundle_author[0]['target_id']) && $field_bundle_author[0]['target_id']){
            $uid = $field_bundle_author[0]['target_id'];
          }
          $target_ids = wxapi_graceYoutube($uri,$type,$uid);
          foreach($target_ids as $target_id){
              // $node->field_nodes_references[] = $target_id;
            $node->field_nodes_reference->appendItem($target_id);
          }
          // \Drupal::logger('create_from_youtube_nids')->notice(print_r($target_ids,1));
        }
    }
}




function wxapi_graceYoutube($url='https://www.youtube.com/watch?v=y4KJegd8inI&list=PLgFvTLP0QRDsUhs2GrsWS6eRUi4GwZtGQ',$type="grace",$uid=1){
    //1.get html from serverless : post url to 
    $uri = 'https://serverless.yongbuzhixi.com/html/post';
    try {
      $response = \Drupal::httpClient()->post($uri,[
        'json'=> [
            'url'=>$url
        ]
      ]);
      //array('headers' => array('Accept' => 'application/json'))
      $data = (string) $response->getBody();
      if (empty($data)) {
        return FALSE;
      }
      $str_html = json_decode($data)->output;
      $html = str_get_html($str_html);
      $output=[];
      foreach($html->find('.yt-uix-scroller-scroll-unit') as $element) {
          if (isset($element->attr['data-video-id']) && isset($element->attr['data-video-title'])) {
            $youtube_vid= $element->attr['data-video-id'];
            $title= $element->attr['data-video-title'];
            // $title = '20131116 恩典365 - 婚姻家庭系列 - 真愛要等待01 : 持守聖潔得著祝福';
            $created = REQUEST_TIME;
            if($type=='grace'){
              preg_match('/\d{8}/', $title,$matches);
              $date  = $matches[0];
              $time_str = implode('-',[substr($date, 0,4),substr($date, 4,2),substr($date, 6,2) ]) . ' 00:00:00';
              $created =  strtotime($time_str);
            }
            //youtube_vid
            $newNode = [
                'type'             => $type,
                'created'          => $created,
                'changed'          => $created,
                'uid'              => $uid, //恩典365基督之家 https://api.yongbuzhixi.com/user/46
                'title'            => $title,
                // An array with taxonomy terms.
                'field_youtube_vid' => [$youtube_vid],
                'body'             => [
                    'summary' => '',
                    'value'   => '',
                    'format'  => 'full_html',
                ],
              ];
              $node = Node::create($newNode);
              $node->save();
              if($type=='grace'){//365
                \Drupal::service('path.alias_storage')->save("/node/" . $node->id(), "/$type/$date", "und");
              }
              $output[]=$node->id();
            }

        }
        return $output;
    }
    catch (RequestException $e) {
      return FALSE;
    }
    // 2.str2html get dom
}